<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red Bunny - Dating at the Bar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body style="font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: #f5f5f5; padding-bottom: 80px;">

<div style="background: linear-gradient(135deg, #FF0000 0%, #CC0000 100%); padding: 1.5rem; text-align: center; box-shadow: 0 4px 20px rgba(255,0,0,0.15); position: sticky; top: 0; z-index: 100;">
    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 0.5rem;">
        <svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="animation: pulse 2s ease-in-out infinite;">
            <circle cx="50" cy="50" r="48" fill="white"/>
            <ellipse cx="35" cy="25" rx="8" ry="20" fill="#FF0000" transform="rotate(-20 35 25)"/>
            <ellipse cx="65" cy="25" rx="8" ry="20" fill="#FF0000" transform="rotate(20 65 25)"/>
            <circle cx="50" cy="55" r="25" fill="#FF0000"/>
            <path d="M 45 65 L 50 75 L 55 65 Z" fill="white"/>
            <line x1="50" y1="75" x2="50" y2="80" stroke="white" stroke-width="2"/>
            <line x1="46" y1="80" x2="54" y2="80" stroke="white" stroke-width="2"/>
        </svg>
        <h1 style="font-size: 2rem; font-weight: 800; color: white; margin: 0;">Red Bunny</h1>
    </div>
    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0;">Find Your Match Tonight üç∑</p>
    <div style="background: rgba(255,255,255,0.15); padding: 0.5rem 1rem; margin-top: 0.8rem; border-radius: 20px; display: flex; justify-content: space-between;">
        <span style="color: white; font-size: 0.85rem; font-weight: 600;"><span style="display: inline-block; width: 8px; height: 8px; background: #00ff00; border-radius: 50%; animation: blink 1.5s infinite;"></span> <span id="status">Connecting...</span></span>
        <span style="color: white; font-size: 0.85rem; font-weight: 600;">üìç Table <span id="table">--</span></span>
    </div>
</div>

<div style="max-width: 600px; margin: 0 auto; padding: 1rem;" id="app"></div>

<div id="nav" style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e0e0e0; display: none; justify-content: space-around; padding: 1rem 0; z-index: 1000;">
    <div onclick="showDiscover()" style="text-align: center; cursor: pointer; color: #FF0000;">
        <div style="font-size: 1.5rem;">üî•</div>
        <div style="font-size: 0.7rem; font-weight: 600;">Discover</div>
    </div>
    <div onclick="showProfile()" style="text-align: center; cursor: pointer; color: #666;">
        <div style="font-size: 1.5rem;">üë§</div>
        <div style="font-size: 0.7rem; font-weight: 600;">Profile</div>
    </div>
</div>

<style>
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
.btn { width: 100%; padding: 1.2rem; background: #FF0000; color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; }
.btn:hover { background: #CC0000; }
.card { background: white; padding: 2rem; border-radius: 20px; margin: 1rem 0; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
</style>

<script>
console.log('üê∞ Red Bunny with REAL DATABASE Starting!');

const PROXY = 'https://small-moth-91.redbunnyparty2.deno.net/api';
let user = null;
let userPhotos = [];
let tg = window.Telegram?.WebApp;
if (tg) { tg.ready(); tg.expand(); }

async function api(endpoint, method = 'GET', body = null) {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(PROXY + endpoint, opts);
    if (!res.ok) throw new Error('API Error');
    const text = await res.text();
    return text ? JSON.parse(text) : null;
}

async function init() {
    try {
        document.getElementById('status').textContent = 'Testing connection...';
        
        await api('/users?limit=1');
        console.log('‚úÖ Database connected via proxy!');
        
        document.getElementById('status').innerHTML = '<span style="color: #00ff00;">‚óè</span> LIVE';
        
        const telegramUser = (tg && tg.initDataUnsafe?.user) 
            ? tg.initDataUnsafe.user 
            : { id: Math.floor(Math.random() * 1000000), first_name: 'Test' };
        
        const users = await api('/users?telegram_id=eq.' + telegramUser.id);
        
        if (users && users.length > 0) {
            user = users[0];
            
            const photos = await api('/photos?user_id=eq.' + user.id + '&order=position.asc');
            if (photos) userPhotos = photos.map(p => p.photo_url);
            
            const checkins = await api('/checkins?user_id=eq.' + user.id + '&is_active=eq.true');
            
            if (checkins && checkins.length > 0) {
                document.getElementById('table').textContent = checkins[0].table_number;
                document.getElementById('nav').style.display = 'flex';
                showDiscover();
            } else {
                showWelcome();
            }
        } else {
            showWelcome();
        }
        
    } catch (error) {
        console.error('Init error:', error);
        document.getElementById('status').textContent = 'Error: ' + error.message;
        document.getElementById('app').innerHTML = `
            <div class="card">
                <h2 style="color: #FF0000;">‚ö†Ô∏è Connection Failed</h2>
                <p>${error.message}</p>
                <button class="btn" onclick="location.reload()">Try Again</button>
            </div>
        `;
    }
}

function showWelcome() {
    document.getElementById('app').innerHTML = `
        <div class="card" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üê∞</div>
            <h2>Welcome to Red Bunny!</h2>
            <p style="color: #666; line-height: 1.6; margin: 1.5rem 0;">Meet singles at the bar tonight! Check in to start matching.</p>
            <div style="font-size: 5rem; margin: 2rem 0; background: #f9f9f9; padding: 2rem; border-radius: 12px; border: 2px dashed #e0e0e0;">üì∑</div>
            <button class="btn" onclick="checkIn()">üì± Check In Now</button>
        </div>
    `;
}

async function checkIn() {
    try {
        const telegramUser = (tg && tg.initDataUnsafe?.user) 
            ? tg.initDataUnsafe.user 
            : { id: Math.floor(Math.random() * 1000000), first_name: 'Test' };
        
        if (!user) {
            const newUser = await api('/users', 'POST', {
                telegram_id: telegramUser.id,
                username: telegramUser.username || '',
                first_name: telegramUser.first_name || 'User',
                last_name: telegramUser.last_name || ''
            });
            user = newUser[0];
        }
        
        const tableNum = Math.floor(Math.random() * 10) + 1;
        await api('/checkins', 'POST', {
            user_id: user.id,
            table_number: tableNum,
            is_active: true
        });
        
        document.getElementById('table').textContent = tableNum;
        
        if (!user.name) {
            showProfileSetup();
        } else {
            document.getElementById('nav').style.display = 'flex';
            showDiscover();
        }
    } catch (error) {
        alert('Check-in failed: ' + error.message);
    }
}

function showProfileSetup() {
    document.getElementById('app').innerHTML = `
        <div class="card">
            <h2 style="margin-bottom: 1.5rem;">‚ú® Complete Your Profile</h2>
            
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #666;">üì∏ Photos</label>
            <div id="photoGallery" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;"></div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;">
            <button class="btn" onclick="document.getElementById('photoInput').click()" style="background: rgba(255,0,0,0.1); color: #FF0000; margin-bottom: 1.5rem;">üì∏ Add Photo</button>
            
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #666;">üë§ Name</label>
            <input type="text" id="name" placeholder="Your first name" style="width: 100%; padding: 1rem; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
            
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #666;">üéÇ Age</label>
            <input type="number" id="age" min="18" max="99" placeholder="18+" style="width: 100%; padding: 1rem; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem;">
            
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #666;">‚úçÔ∏è Bio (Optional)</label>
            <textarea id="bio" placeholder="Tell people about yourself..." style="width: 100%; padding: 1rem; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; margin-bottom: 1rem; min-height: 100px;"></textarea>
            
            <button class="btn" onclick="saveProfile()">‚úÖ Save & Start Matching</button>
        </div>
    `;
    
    document.getElementById('photoInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            alert('Please select an image');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async function(event) {
            const photoUrl = event.target.result;
            userPhotos.push(photoUrl);
            
            await api('/photos', 'POST', {
                user_id: user.id,
                photo_url: photoUrl,
                is_primary: userPhotos.length === 1,
                position: userPhotos.length - 1
            });
            
            renderPhotos();
        };
        reader.readAsDataURL(file);
    });
}

function renderPhotos() {
    document.getElementById('photoGallery').innerHTML = userPhotos.map((url, i) => `
        <div style="position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; background: #f0f0f0;">
            <img src="${url}" style="width: 100%; height: 100%; object-fit: cover;">
            <button onclick="deletePhoto(${i})" style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(255,0,0,0.9); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.5rem;">√ó</button>
        </div>
    `).join('');
}

async function deletePhoto(index) {
    if (!confirm('Delete?')) return;
    await api('/photos?user_id=eq.' + user.id + '&photo_url=eq.' + encodeURIComponent(userPhotos[index]), 'DELETE');
    userPhotos.splice(index, 1);
    renderPhotos();
}

async function saveProfile() {
    const name = document.getElementById('name').value.trim();
    const age = parseInt(document.getElementById('age').value);
    const bio = document.getElementById('bio').value.trim();
    
    if (!name || !age || userPhotos.length === 0) {
        alert('Please add photo, name, and age!');
        return;
    }
    
    await api('/users?id=eq.' + user.id, 'PATCH', { name, age, bio });
    user.name = name;
    user.age = age;
    document.getElementById('nav').style.display = 'flex';
    showDiscover();
}

async function showDiscover() {
    try {
        const checkins = await api('/checkins?is_active=eq.true&user_id=neq.' + user.id + '&select=table_number,user_id');
        const count = checkins ? checkins.length : 0;
        
        document.getElementById('status').innerHTML = `<span style="color: #00ff00;">‚óè</span> ${count} singles here`;
        
        if (count === 0) {
            document.getElementById('app').innerHTML = `
                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üê∞</div>
                    <h3>No one else here yet!</h3>
                    <p style="color: #666;">Be the first tonight üî•</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        for (const checkin of checkins) {
            const users = await api('/users?id=eq.' + checkin.user_id);
            if (!users || users.length === 0) continue;
            const otherUser = users[0];
            
            const photos = await api('/photos?user_id=eq.' + otherUser.id + '&is_primary=eq.true&limit=1');
            const photoUrl = photos && photos[0] ? photos[0].photo_url : null;
            
            html += `
                <div style="background: white; border-radius: 25px; overflow: hidden; margin-bottom: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                    <div style="position: relative; width: 100%; height: 350px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                        ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 4rem;">üë§</span>'}
                        <div style="position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.7); padding: 0.5rem 1rem; border-radius: 20px; color: white; font-size: 0.85rem; font-weight: 600;">Here Now üî¥</div>
                        <div style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,0,0,0.9); padding: 0.5rem 1rem; border-radius: 20px; color: white; font-size: 0.85rem; font-weight: 600;">Table ${checkin.table_number}</div>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem;">${otherUser.name}, ${otherUser.age}</div>
                        ${otherUser.bio ? `<div style="color: #666; line-height: 1.6; margin-bottom: 1rem;">${otherUser.bio}</div>` : ''}
                        <div style="display: flex; justify-content: center; gap: 1.5rem; padding: 1rem 0;">
                            <button onclick="pass()" style="width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; cursor: pointer; background: rgba(255,0,0,0.2); color: #FF0000;">‚úï</button>
                            <button onclick="like('${otherUser.id}')" style="width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; cursor: pointer; background: rgba(0,255,0,0.2); color: #00FF00;">‚ù§Ô∏è</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('app').innerHTML = html;
    } catch (error) {
        console.error('Load users error:', error);
    }
}

function pass() {
    const cards = document.querySelectorAll('[style*="border-radius: 25px"]');
    if (cards.length > 0) cards[0].remove();
}

async function like(userId) {
    try {
        await api('/matches', 'POST', { user1_id: user.id, user2_id: userId });
        alert('Match! üíï');
    } catch (e) {}
    pass();
}

async function showProfile() {
    const photoUrl = userPhotos[0] || null;
    document.getElementById('app').innerHTML = `
        <div style="background: white; border-radius: 25px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            <div style="position: relative; width: 100%; height: 350px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                ${photoUrl ? `<img src="${photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 4rem;">üë§</span>'}
                <div style="position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.7); padding: 0.5rem 1rem; border-radius: 20px; color: white; font-size: 0.85rem; font-weight: 600;">Here Now üî¥</div>
            </div>
            <div style="padding: 1.5rem;">
                <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem;">${user.name}, ${user.age}</div>
                ${user.bio ? `<div style="color: #666; line-height: 1.6; margin-bottom: 1rem;">${user.bio}</div>` : ''}
            </div>
        </div>
        <button class="btn" style="margin-top: 1rem; background: rgba(255,0,0,0.2); color: #FF0000;" onclick="checkOut()">üö™ Check Out</button>
    `;
}

async function checkOut() {
    if (!confirm('Check out?')) return;
    await api('/checkins?user_id=eq.' + user.id + '&is_active=eq.true', 'PATCH', { is_active: false });
    document.getElementById('table').textContent = '--';
    document.getElementById('nav').style.display = 'none';
    showWelcome();
}

init();
setInterval(() => {
    if (document.getElementById('app').innerHTML.includes('Table')) showDiscover();
}, 30000);
</script>
</body>
</html>
